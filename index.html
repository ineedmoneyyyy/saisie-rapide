<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Saisie rapide</title>
  <!-- iPhone 13 Pro (390px) plein écran, pas de zoom, pas de scroll de page -->
  <meta name="viewport" content="width=390, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <style>
    :root{
      --primary:#6f57d3; --bg:#f2f2f7; --fg:#111; --border:#d9d9de;
      --r:14px; --pad:18px; --maxw:390px;
    }
    /* Plein écran sans scroll */
    html,body{height:100%; overflow:hidden;}
    body{
      margin:0; padding:0; background:var(--bg); color:var(--fg);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
      font-size:18px; line-height:1.35; -webkit-text-size-adjust:100%;
      overscroll-behavior:none;
    }

    /* Écran fixe : header + contenu + bouton bas */
    .screen{
      position:fixed; inset:0; display:flex; flex-direction:column;
      padding:calc(env(safe-area-inset-top,0)+8px) env(safe-area-inset-right,0) calc(env(safe-area-inset-bottom,0)+0) env(safe-area-inset-left,0);
    }
    .wrap{ width:100%; max-width:var(--maxw); margin:0 auto; box-sizing:border-box; padding:0 var(--pad); }

    header.wrap{
      padding-top:8px; padding-bottom:6px;
    }
    h1{ margin:0; font-size:32px; font-weight:800; }

    /* zone formulaire : on évite le scroll global, on laisse juste cette zone s’adapter si besoin */
    .content{
      flex:1; min-height:0;
      display:flex; justify-content:flex-start;
    }
    .content .wrap{
      padding-top:8px; padding-bottom:10px;
      display:flex; flex-direction:column; gap:12px;
    }

    label{ display:block; font-size:18px; font-weight:700; margin:10px 0 6px; }
    input, select{
      width:100%; box-sizing:border-box; background:#fff;
      border:1px solid var(--border); border-radius:var(--r);
      padding:14px 16px; font-size:18px; min-height:52px; outline:none;
    }
    input:focus,select:focus{ border-color:#c7b8ff; box-shadow:0 0 0 3px rgba(111,87,211,.15); }

    .row{ display:flex; gap:12px; }
    .row > div{ flex:1; min-width:0; }
    .hint{ font-size:14px; color:#666; margin-top:4px; }
    .hidden{ display:none !important; }

    /* Barre d’action fixe en bas, sans scroll */
    .actions{
      padding:10px 0 calc(env(safe-area-inset-bottom,0) + 14px);
      background:linear-gradient(180deg, rgba(242,242,247,0) 0%, var(--bg) 50%);
    }
    .actions .wrap{ padding-top:0; }
    button#submit{
      width:100%; height:60px; border:none; border-radius:16px;
      background:var(--primary); color:#fff; font-size:20px; font-weight:800; letter-spacing:.2px;
      box-shadow:0 10px 24px rgba(111,87,211,.25); cursor:pointer; touch-action:manipulation;
    }
    button#submit:disabled{ opacity:.6; cursor:default; }

    .msg{ font-size:16px; color:#0a8a0a; margin-top:6px; }
    .err{ font-size:16px; color:#c62828; margin-top:6px; }
  </style>
</head>
<body>
  <div class="screen">
    <header class="wrap">
      <h1>Saisie rapide</h1>
    </header>

    <main class="content">
      <div class="wrap">
        <label>Type de transaction</label>
        <select id="type">
          <option>Achat stock</option>
          <option>Frais annexes</option>
          <option>Vente/Cashout</option>
          <option>Abonnement (mensuel)</option>
          <option>Paiement perso</option>
        </select>

        <!-- ACHAT -->
        <div id="bloc-achat" class="bloc">
          <label>Item / Référence</label>
          <input id="item" type="text" placeholder="Ex: 100 Jeans Levi's 501">
          <div class="row">
            <div>
              <label>Date</label>
              <input id="date-achat" type="date">
            </div>
            <div>
              <label>Montant (€)</label>
              <input id="montant-achat" type="text" inputmode="decimal" placeholder="ex: 79,90">
              <div class="hint">Décimales : virgule ou point</div>
            </div>
          </div>
          <label>Fournisseur</label>
          <select id="fournisseur"></select>
          <label>Payeur</label>
          <select id="payeur-achat"></select>
        </div>

        <!-- FRAIS -->
        <div id="bloc-frais" class="bloc hidden">
          <label>Description du frais</label>
          <input id="frais-desc" type="text" placeholder="Ex: Pochettes, URSSAF, etc.">
          <div class="row">
            <div>
              <label>Date</label>
              <input id="date-frais" type="date">
            </div>
            <div>
              <label>Montant (€)</label>
              <input id="montant-frais" type="text" inputmode="decimal" placeholder="ex: 12,50">
            </div>
          </div>
          <label>Catégorie</label>
          <select id="categorie"></select>
          <label>Payeur</label>
          <select id="payeur-frais"></select>
        </div>

        <!-- VENTE -->
        <div id="bloc-vente" class="bloc hidden">
          <div class="row">
            <div>
              <label>Date</label>
              <input id="date-vente" type="date">
            </div>
            <div>
              <label>Montant (€)</label>
              <input id="montant-vente" type="text" inputmode="decimal" placeholder="ex: 45">
            </div>
          </div>
          <label>Compte Vinted</label>
          <select id="compte-vinted"></select>
          <label>Vendeur</label>
          <select id="vendeur"></select>
        </div>

        <!-- ABONNEMENT -->
        <div id="bloc-abo" class="bloc hidden">
          <label>Nom de l’abonnement</label>
          <input id="abo-nom" type="text" placeholder="Ex: ChatGPT Plus">
          <div class="row">
            <div>
              <label>Montant (€)</label>
              <input id="abo-montant" type="text" inputmode="decimal" placeholder="ex: 20">
            </div>
            <div>
              <label>Jour du mois</label>
              <input id="abo-jour" type="number" min="1" max="31" value="5">
            </div>
          </div>
          <label>Catégorie</label>
          <select id="abo-categorie"></select>
          <label>Payeur</label>
          <select id="abo-payeur"></select>
          <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
            <input id="abo-actif" type="checkbox" checked style="width:22px;height:22px;">
            <label for="abo-actif" style="margin:0;font-weight:600;">Actif (Oui)</label>
          </div>
        </div>

        <!-- PAIEMENT -->
        <div id="bloc-paiement" class="bloc hidden">
          <div class="row">
            <div>
              <label>Date</label>
              <input id="date-paiement" type="date">
            </div>
            <div>
              <label>Montant (€)</label>
              <input id="montant-paiement" type="text" inputmode="decimal" placeholder="ex: 1000">
            </div>
          </div>
          <label>Personne</label>
          <select id="payeur-perso"></select>
        </div>

        <div id="feedback" class="msg" style="display:none;"></div>
        <div id="error" class="err" style="display:none;"></div>
      </div>
    </main>

    <div class="actions">
      <div class="wrap">
        <button id="submit">➕ Ajouter</button>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    const ENDPOINT = "https://script.google.com/macros/s/AKfycbw-kCzf14Oc6ww92VkcJXb5103tBBlTCBrPezQNdxJx-jwwo5erUTFJSy75ChPOfDZEuQ/exec";

    // ====== UI : blocks ======
    const $ = id => document.getElementById(id);
    const blocs = {
      "Achat stock":         "bloc-achat",
      "Frais annexes":       "bloc-frais",
      "Vente/Cashout":       "bloc-vente",
      "Abonnement (mensuel)":"bloc-abo",
      "Paiement perso":      "bloc-paiement"
    };
    function switchTypeUI(){
      const t = $("type").value;
      Object.values(blocs).forEach(id => $(id).classList.add("hidden"));
      $(blocs[t]).classList.remove("hidden");
    }
    $("type").addEventListener("change", switchTypeUI);

    // ====== Lists depuis Apps Script ======
    function fillSelect(sel, arr){ sel.innerHTML=""; (arr||[]).forEach(v=>{ const o=document.createElement("option"); o.value=o.textContent=v; sel.appendChild(o); }); }
    async function loadLists(){
      try{
        const r = await fetch(ENDPOINT + "?api=lists");
        const {data} = await r.json();
        fillSelect($("payeur-achat"), data.personnes);
        fillSelect($("fournisseur"), data.fournisseurs);
        fillSelect($("payeur-frais"), data.personnes);
        fillSelect($("categorie"), data.categories);
        fillSelect($("compte-vinted"), data.comptesVinted);
        fillSelect($("vendeur"), data.personnes);
        fillSelect($("abo-categorie"), data.categories);
        fillSelect($("abo-payeur"), data.personnes);
        fillSelect($("payeur-perso"), data.personnes);
      }catch(e){
        $("error").textContent = "Erreur listes: " + e.message;
        $("error").style.display = "block";
      }
    }

    // Dates du jour
    (function setToday(){
      const t=new Date(), yyyy=t.getFullYear(), mm=String(t.getMonth()+1).padStart(2,"0"), dd=String(t.getDate()).padStart(2,"0");
      $("date-achat").value = `${yyyy}-${mm}-${dd}`;
      $("date-frais").value = `${yyyy}-${mm}-${dd}`;
      $("date-vente").value = `${yyyy}-${mm}-${dd}`;
      $("date-paiement").value = `${yyyy}-${mm}-${dd}`;
    })();

    // ====== Submit ======
    $("submit").addEventListener("click", async ()=>{
      $("submit").disabled = true; $("feedback").style.display="none"; $("error").style.display="none";

      const type = $("type").value;
      const p = { type };

      if(type==="Achat stock"){
        p.item=$("item").value; p.dateISO=$("date-achat").value; p.montant=$("montant-achat").value; p.fournisseur=$("fournisseur").value; p.payeur=$("payeur-achat").value;
      } else if(type==="Frais annexes"){
        p.fraisDesc=$("frais-desc").value; p.dateISO=$("date-frais").value; p.montant=$("montant-frais").value; p.categorie=$("categorie").value; p.payeur=$("payeur-frais").value;
      } else if(type==="Vente/Cashout"){
        p.dateISO=$("date-vente").value; p.montant=$("montant-vente").value; p.compteVinted=$("compte-vinted").value; p.vendeur=$("vendeur").value;
      } else if(type==="Abonnement (mensuel)"){
        p.aboNom=$("abo-nom").value; p.montant=$("abo-montant").value; p.aboJour=$("abo-jour").value; p.categorie=$("abo-categorie").value; p.payeur=$("abo-payeur").value; p.aboActif=$("abo-actif").checked;
      } else { // Paiement perso
        p.dateISO=$("date-paiement").value; p.montant=$("montant-paiement").value; p.personne=$("payeur-perso").value;
      }

      try{
        const r = await fetch(ENDPOINT, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(p) });
        const json = await r.json().catch(()=>({}));
        if(!r.ok || json.ok===false) throw new Error(json.error || ("HTTP "+r.status));
        $("feedback").textContent="Ajouté ✅"; $("feedback").style.display="block";
        // reset champs principaux du bloc visible
        if(type==="Achat stock"){ $("item").value=""; $("montant-achat").value=""; }
        else if(type==="Frais annexes"){ $("frais-desc").value=""; $("montant-frais").value=""; }
        else if(type==="Vente/Cashout"){ $("montant-vente").value=""; }
        else if(type==="Abonnement (mensuel)"){ $("abo-nom").value=""; $("abo-montant").value=""; }
        else { $("montant-paiement").value=""; }
      }catch(e){
        $("error").textContent="Erreur: "+e.message; $("error").style.display="block";
      }finally{
        $("submit").disabled=false;
      }
    });

    // Init
    switchTypeUI(); // affiche le bon bloc au chargement
    loadLists();    // remplit les sélecteurs
  </script>
</body>
</html>
